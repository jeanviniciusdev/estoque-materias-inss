{% extends 'stock/base.html' %}
{% block content %}
<div class="card shadow-sm p-4 mb-3" style="background-color: #001D40; border-radius: 10px;">
  <div class="d-flex justify-content-between align-items-center mb-4">
    <h2 class="fw-bold text-light mb-0">üì¶ Materiais</h2>

    <div class="d-flex gap-2 align-items-center">
      <!-- Adicionar material (mant√©m) -->
      <a class="btn btn-success me-2" href="{% url 'materials_add' %}">Adicionar material</a>

      <!-- Exportar Materiais (dropdown CSV / XLSX) -->
      <div class="btn-group">
        <button type="button" class="btn btn-outline-light btn-sm">Exportar Materiais</button>
        <button type="button" class="btn btn-outline-light btn-sm dropdown-toggle dropdown-toggle-split" data-bs-toggle="dropdown" aria-expanded="false">
          <span class="visually-hidden">Toggle</span>
        </button>
        <ul class="dropdown-menu">
          <li><a class="dropdown-item" href="{% url 'export_materials_csv' %}?format=csv">CSV</a></li>
          <li><a class="dropdown-item" href="{% url 'export_materials_csv' %}?format=xlsx">Excel (.xlsx)</a></li>
        </ul>
      </div>

      <!-- Exportar Movimentos (dropdown CSV / XLSX) -->
      <div class="btn-group">
        <button type="button" class="btn btn-outline-light btn-sm">Exportar Movimentos</button>
        <button type="button" class="btn btn-outline-light btn-sm dropdown-toggle dropdown-toggle-split" data-bs-toggle="dropdown" aria-expanded="false">
          <span class="visually-hidden">Toggle</span>
        </button>
        <ul class="dropdown-menu">
          <li><a class="dropdown-item" href="{% url 'export_movements_csv' %}?format=csv">CSV</a></li>
          <li><a class="dropdown-item" href="{% url 'export_movements_csv' %}?format=xlsx">Excel (.xlsx)</a></li>
        </ul>
      </div>
    </div>
  </div>

  <div class="table-responsive">
    <table class="table mb-0 text-light" style="background-color: transparent; border-radius: 8px; overflow: hidden;">
      <thead>
        <tr style="background-color: #00285E;">
          <th>Nome</th>
          <th>Quantidade</th>
          <th>M√≠nimo</th>
          <th>A√ß√µes</th>
        </tr>
      </thead>
      <tbody>
        {% for m in materiais %}
        <tr class="table-row">
          <td class="fw-semibold">{{ m.nome }}</td>
          <td>{{ m.quantidade }}</td>
          <td>{{ m.minimo }}</td>
          <td>
            <a class="btn btn-sm btn-primary me-2" href="{% url 'materials_edit' m.pk %}">Editar</a>
            {% if user.is_staff %}
            <button
              type="button"
              class="btn btn-sm btn-danger btn-open-delete"
              data-id="{{ m.id }}"
              data-name="{{ m.nome }}"
              data-url-template="{% url 'materials_delete' 0 %}"
            >Excluir</button>
            {% endif %}
          </td>
        </tr>
        {% empty %}
        <tr>
          <td colspan="4" class="text-center py-3 text-light">Nenhum material cadastrado.</td>
        </tr>
        {% endfor %}
      </tbody>
    </table>
  </div>
</div>

<!-- Modal de confirma√ß√£o -->
<div class="modal" id="deleteModal" tabindex="-1" role="dialog" aria-hidden="true" style="display:none;">
  <div class="modal-dialog" role="document">
    <div class="modal-content">
      <form id="deleteForm" method="post" action="">
        {% csrf_token %}
        <div class="modal-header">
          <h5 class="modal-title" id="deleteModalTitle">Confirmar exclus√£o</h5>
          <button type="button" class="close btn-close-modal" aria-label="Close">&times;</button>
        </div>
        <div class="modal-body">
          <p id="deleteModalBody">Tem certeza que deseja excluir este material?</p>
          <div>
            <label for="id_motivo">Motivo (opcional)</label><br>
            <textarea id="id_motivo" name="motivo" rows="4" cols="50" placeholder="Descreva um motivo..."></textarea>
          </div>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary btn-close-modal">Cancelar</button>
          <button type="submit" class="btn btn-danger">Confirmar exclus√£o</button>
        </div>
      </form>
    </div>
  </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function () {
  const modal = document.getElementById('deleteModal');
  const form = document.getElementById('deleteForm');
  const title = document.getElementById('deleteModalTitle');
  const body = document.getElementById('deleteModalBody');
  const closeButtons = document.querySelectorAll('.btn-close-modal');

  function showModal() { modal.style.display = 'block'; }
  function hideModal() { modal.style.display = 'none'; }

  document.querySelectorAll('.btn-open-delete').forEach(function(btn){
    btn.addEventListener('click', function(){
      const id = this.dataset.id;
      const name = this.dataset.name;
      const urlTemplate = this.dataset.urlTemplate; // e.g. "/materials/0/delete/"
      // monta action substituindo o 0 pela id real
      const action = urlTemplate.replace('/0/', '/' + id + '/');
      form.action = action;
      title.textContent = 'Excluir material: ' + name;
      body.textContent = 'Tem certeza que deseja excluir "' + name + '"?';
      // limpa motivo
      form.querySelector('textarea[name="motivo"]').value = '';
      showModal();
    });
  });

  closeButtons.forEach(function(b){ b.addEventListener('click', hideModal); });

  // fecha modal se clicar fora do conte√∫do
  modal.addEventListener('click', function(e){
    if (e.target === modal) hideModal();
  });
});
</script>

<style>
  /* === Estilo da tabela === */
  table {
    border-collapse: separate;
    border-spacing: 0;
  }

  thead th {
    color: #FFFFFF;
    font-weight: 600;
    border-bottom: 2px solid rgba(255, 255, 255, 0.1);
  }

  /* Linhas alternadas */
  tbody tr:nth-child(odd) {
    background-color: #00285E; /* Azul escuro */
  }

  tbody tr:nth-child(even) {
    background-color: #001B3A; /* Azul um pouco mais escuro */
  }

  /* Hover suave */
  tbody tr:hover {
    background-color: #013A7A;
    transition: background-color 0.3s ease;
  }

  /* Remover bordas padr√£o */
  td, th {
    border: none !important;
    vertical-align: middle;
  }

  /* Bot√µes coerentes com o tema */
  .btn-outline-light {
    border: 1px solid rgba(255, 255, 255, 0.4);
    color: #fff;
  }
  .btn-outline-light:hover {
    background-color: #1C64AE;
    border-color: #1C64AE;
  }

  .btn-primary {
    background-color: #1C64AE;
    border: none;
  }
  .btn-primary:hover {
    background-color: #155b99;
  }

  .btn-danger {
    background-color: #C0392B;
    border: none;
  }
  .btn-danger:hover {
    background-color: #A93226;
  }

  .btn-success {
    background-color: #27AE60;
    border: none;
  }
  .btn-success:hover {
    background-color: #229954;
  }
</style>
{% endblock %}
