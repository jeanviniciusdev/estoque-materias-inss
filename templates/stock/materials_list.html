{% extends 'stock/base.html' %}
{% block content %}
<div class="card shadow-sm p-4 mb-3" style="background-color: #001D40; border-radius: 10px;">
  <div class="d-flex justify-content-between align-items-center mb-4">
    <h2 class="fw-bold text-light mb-0">üì¶ Materiais</h2>
    <div>
      <a class="btn btn-success me-2" href="{% url 'materials_add' %}">Adicionar material</a>
      <a class="btn btn-outline-light me-2" href="{% url 'export_materials_csv' %}">Exportar materiais (CSV)</a>
      <a class="btn btn-outline-light" href="{% url 'export_movements_csv' %}">Exportar movimentos (CSV)</a>
    </div>
  </div>

  <div class="table-responsive">
    <table id="materialsTable" class="table mb-0" style="background-color: transparent; border-radius: 8px; overflow: hidden;">
      <thead>
        <tr>
          <th class="text-light">Id</th>
          <th class="text-light">Nome</th>
          <th class="text-light">Quantidade</th>
          <th class="text-light">Quantidade ideal</th>
          <th class="text-light">A√ß√µes</th>
        </tr>
      </thead>
      <tbody>
        {% for m in materiais %}
        <tr class="table-row">
          <td>{{ forloop.counter }}.</td>
          <td class="fw-semibold">
            {% if m.imagem %}
              <a href="#" class="material-name" data-img-url="{{ m.imagem.url }}">{{ m.nome }}</a>
            {% else %}
              {{ m.nome }}
            {% endif %}
          </td>
          <td>{{ m.quantidade }}</td>
          <td>{{ m.minimo }}</td>
          <td>
            <a class="btn btn-sm btn-primary me-2" href="{% url 'materials_edit' m.pk %}">Editar</a>
            {% if user.is_staff %}
            <button
              type="button"
              class="btn btn-sm btn-danger btn-open-delete"
              data-id="{{ m.id }}"
              data-name="{{ m.nome }}"
              data-url-template="{% url 'materials_delete' 0 %}"
            >Excluir</button>
            {% endif %}
          </td>
        </tr>
        {% empty %}
        <tr>
          <td colspan="5" class="text-center py-3 text-light">Nenhum material cadastrado.</td>
        </tr>
        {% endfor %}
      </tbody>
    </table>
  </div>
</div>

<!-- Modal de confirma√ß√£o -->
<div class="modal" id="deleteModal" tabindex="-1" role="dialog" aria-hidden="true" style="display:none;">
  <div class="modal-dialog" role="document">
    <div class="modal-content">
      <form id="deleteForm" method="post" action="">
        {% csrf_token %}
        <div class="modal-header">
          <h5 class="modal-title" id="deleteModalTitle">Confirmar exclus√£o</h5>
          <button type="button" class="close btn-close-modal" aria-label="Close">&times;</button>
        </div>
        <div class="modal-body">
          <p id="deleteModalBody">Tem certeza que deseja excluir este material?</p>
          <div>
            <label for="id_motivo">Motivo (opcional)</label><br>
            <textarea id="id_motivo" name="motivo" rows="4" cols="50" placeholder="Descreva um motivo..."></textarea>
          </div>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary btn-close-modal">Cancelar</button>
          <button type="submit" class="btn btn-danger">Confirmar exclus√£o</button>
        </div>
      </form>
    </div>
  </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function () {
  const modal = document.getElementById('deleteModal');
  const form = document.getElementById('deleteForm');
  const title = document.getElementById('deleteModalTitle');
  const body = document.getElementById('deleteModalBody');
  const closeButtons = document.querySelectorAll('.btn-close-modal');

  function showModal() { modal.style.display = 'block'; }
  function hideModal() { modal.style.display = 'none'; }

  document.querySelectorAll('.btn-open-delete').forEach(function(btn){
    btn.addEventListener('click', function(){
      const id = this.dataset.id;
      const name = this.dataset.name;
      const urlTemplate = this.dataset.urlTemplate; // e.g. "/materials/0/delete/"
      // monta action substituindo o 0 pela id real
      const action = urlTemplate.replace('/0/', '/' + id + '/');
      form.action = action;
      title.textContent = 'Excluir material: ' + name;
      body.textContent = 'Tem certeza que deseja excluir "' + name + '"?';
      // limpa motivo
      form.querySelector('textarea[name="motivo"]').value = '';
      showModal();
    });
  });

  closeButtons.forEach(function(b){ b.addEventListener('click', hideModal); });

  // fecha modal se clicar fora do conte√∫do
  modal.addEventListener('click', function(e){
    if (e.target === modal) hideModal();
  });
});
</script>

<style>
  /* === Estilo da tabela === */
  table {
    border-collapse: separate;
    border-spacing: 0;
  }

  thead th {
    color: var(--text-color);
    font-weight: 600;
    border-bottom: 2px solid rgba(255, 255, 255, 0.06);
  }

  /* Linhas alternadas (use o card color como base, ajustado por tema)
     cores ser√£o for√ßadas por `base.html` para azul/escuro/claro */
  tbody tr:nth-child(odd) {
    background-color: transparent;
  }

  tbody tr:nth-child(even) {
    background-color: transparent;
  }

  /* Hover suave */
  tbody tr:hover {
    background-color: rgba(255,255,255,0.03);
    transition: background-color 0.3s ease;
  }

  /* Remover bordas padr√£o */
  td, th {
    border: none !important;
    vertical-align: middle;
  }

  /* Bot√µes coerentes com o tema */
  .btn-outline-light {
    border: 1px solid rgba(255, 255, 255, 0.4);
    color: #fff;
  }
  .btn-outline-light:hover {
    background-color: #1C64AE;
    border-color: #1C64AE;
  }

  /* Em tema claro, tornar os bot√µes outline-light na cor primaria (azul) */
  body[data-theme="claro"] .btn-outline-light {
    border: 1px solid var(--btn-primary);
    color: var(--btn-primary);
  }
  body[data-theme="claro"] .btn-outline-light:hover {
    background-color: var(--btn-primary);
    border-color: var(--btn-primary);
    color: #fff;
  }

  .btn-primary {
    background-color: #1C64AE;
    border: none;
  }
  .btn-primary:hover {
    background-color: #155b99;
  }

  .btn-danger {
    background-color: #C0392B;
    border: none;
  }
  .btn-danger:hover {
    background-color: #A93226;
  }

  .btn-success {
    background-color: #27AE60;
    border: none;
  }
  .btn-success:hover {
    background-color: #229954;
  }
</style>
<!-- Image preview modal (centered) -->
<div id="imgModal" class="img-modal-overlay" style="display:none;">
  <div class="img-modal-content">
    <button type="button" class="img-modal-close" aria-label="Fechar">√ó</button>
    <img id="imgModalImg" src="" alt="Preview" class="img-modal-img">
  </div>
</div>

<style>
  .img-modal-overlay{position:fixed;inset:0;display:none;background:rgba(0,0,0,0.65);justify-content:center;align-items:center;z-index:1200}
  .img-modal-content{position:relative;max-width:96vw;max-height:92vh;display:flex;justify-content:center;align-items:center}
  .img-modal-img{max-width:100%;max-height:100%;object-fit:contain;border-radius:8px;box-shadow:0 8px 28px rgba(0,0,0,0.6)}
  .img-modal-close{position:absolute;top:-10px;right:-10px;background:#fff;border-radius:50%;width:36px;height:36px;border:none;cursor:pointer;box-shadow:0 4px 12px rgba(0,0,0,0.25)}
</style>

<script>
document.addEventListener('click', function(e){
  const a = e.target.closest && e.target.closest('.material-name');
  if (a){
    e.preventDefault();
    const url = a.dataset.imgUrl;
    if (!url) return;
    const modal = document.getElementById('imgModal');
    const img = document.getElementById('imgModalImg');
    const close = modal.querySelector('.img-modal-close');
    img.src = url; modal.style.display = 'flex'; document.body.style.overflow='hidden';
    function hide(){ modal.style.display='none'; img.src=''; document.body.style.overflow=''; }
    close.onclick = hide; modal.onclick = (ev)=>{ if(ev.target===modal) hide(); };
  }
});
</script>
{% endblock %}
