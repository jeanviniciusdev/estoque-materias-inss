{% extends 'stock/base.html' %}
{% block content %}

<div class="row g-3">

  <!-- Gr√°fico 1: Estoque por Material -->
  <div class="col-md-8">
    <div class="card shadow-sm mb-3">
      <div class="card-body" style="height:350px; padding-bottom:40px;">
        <h4 class="fw-bold mb-3 text-light">üì¶ Estoque por material</h4>
        <div style="position: relative; height:100%; width:100%;">
          <!-- Substitui o gr√°fico por uma tabela com scroll que lista materiais -->
          <div id="estoqueTableContainer" style="height:90%; width:100%; display:flex; flex-direction:column;">
            <div style="flex:1 1 auto; overflow:auto;">
              <table id="estoqueTable" class="table mb-0" style="background-color: transparent; border-radius: 8px;">
                <thead>
                  <tr>
                    <th class="text-light">Id</th>
                    <th class="text-light">Nome</th>
                    <th class="text-light">Quantidade</th>
                    <th class="text-light">M√≠nimo</th>
                  </tr>
                </thead>
                <tbody>
                  <tr><td colspan="4" class="text-center text-muted">Carregando...</td></tr>
                </tbody>
              </table>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Coluna lateral com Atalhos + Alertas -->
  <div class="col-md-4">
    <!-- Atalhos -->
    <div class="card shadow-sm mb-3">
      <div class="card-body">
        <h5 class="fw-bold mb-3 text-light">‚ÜóÔ∏èÔ∏è Atalhos</h5>
        <a class="btn btn-success w-100 mb-2" href="{% url 'materials_add' %}">Adicionar material</a>
        <a class="btn btn-primary w-100 mb-2" href="{% url 'movimento_add' %}">Registrar movimento</a>
        <a class="btn btn-danger w-100 mb-2" href="{% url 'materials_list' %}">Editar materiais</a>
      </div>
    </div>

<!-- Alertas -->
<div class="card shadow-sm" style="max-height:350px; overflow-y:auto;">
  <div class="card-header bg-warning text-dark d-flex justify-content-between align-items-center">
    <strong>‚ö†Ô∏è Materiais abaixo do m√≠nimo</strong>
    <a href="{% url 'alertas_completos' %}" class="btn btn-sm btn-outline-dark">Ver todos</a>
  </div>
  <ul class="list-group list-group-flush">
    {% if materiais_em_alerta %}
      {% for mat in materiais_em_alerta|slice:":2" %}  {# Mostra apenas os 2 primeiros #}
      <li class="list-group-item d-flex justify-content-between align-items-center">
        {{ mat.nome }}
        <span class="badge bg-danger rounded-pill">{{ mat.quantidade }}/{{ mat.minimo }}</span>
      </li>
      {% endfor %}
    {% else %}
      <li class="list-group-item text-center text-muted">
        Nenhum material abaixo do m√≠nimo.
      </li>
    {% endif %}
  </ul>
</div>

  </div>
</div>

<!-- Gr√°fico 2: Comparativo de Estoques -->
<div class="card shadow-sm mb-3 mt-3">
  <div class="card-body" style="height:350px; padding-bottom:40px;">
    <h4 class="fw-bold mb-3 text-light">üìà Comparativo de Estoques</h4>
    <div style="position: relative; height:100%; width:100%;">
      <canvas id="comparativoChart"></canvas>
    </div>
  </div>
</div>

<!-- Chart.js -->
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<script>
async function loadData() {
  const resp = await fetch('{% url "api_materials" %}');
  const data = await resp.json();

  const labels = data.map(d => d.nome);
  const values = data.map(d => d.quantidade);

  // Helper: map theme -> colors
  function getThemeColors() {
    const currentTheme = document.body.getAttribute('data-theme') || 'escuro';
    let textColor = '#FFFFFF';
    let tooltipBg = '#001D40';
    let gridColor = 'rgba(255,255,255,0.1)';
    if (currentTheme === 'claro') {
      textColor = '#000000';
      tooltipBg = '#ffffff';
      gridColor = 'rgba(0,0,0,0.12)';
    }
    return { currentTheme, textColor, tooltipBg, gridColor };
  }

  // Populate scrollable table with materials
  function populateTable(items) {
    const tbody = document.querySelector('#estoqueTable tbody');
    if (!tbody) return;
    tbody.innerHTML = '';
    if (!items || items.length === 0) {
      tbody.innerHTML = '<tr><td colspan="4" class="text-center text-muted">Nenhum material encontrado.</td></tr>';
      return;
    }

    // Create rows
    items.forEach((item, idx) => {
      const tr = document.createElement('tr');
      const tdIdx = document.createElement('td'); tdIdx.textContent = String(idx + 1) + '.';
      const tdName = document.createElement('td'); tdName.textContent = item.nome;
      const tdQty = document.createElement('td'); tdQty.textContent = item.quantidade;
      const tdMin = document.createElement('td'); tdMin.textContent = item.minimo;
      tr.appendChild(tdIdx); tr.appendChild(tdName); tr.appendChild(tdQty); tr.appendChild(tdMin);
      tbody.appendChild(tr);
    });

    // Apply theme colors to header and cells
    const { textColor } = getThemeColors();
    document.querySelectorAll('#estoqueTable thead th').forEach(th => th.style.color = textColor);
    document.querySelectorAll('#estoqueTable tbody td').forEach(td => td.style.color = textColor);
  }

  // Chart 2 only (comparativo)
  let chart2 = null;
  function createChart2(items) {
    const { textColor, tooltipBg, gridColor } = getThemeColors();
    if (chart2) { chart2.destroy(); chart2 = null; }
    const ctx2 = document.getElementById('comparativoChart').getContext('2d');
    chart2 = new Chart(ctx2, {
      type: 'bar',
      data: {
        labels: items.map(d => d.nome),
        datasets: [
          { label: 'M√≠nimo', data: items.map(d => d.minimo), backgroundColor: '#C0392B', borderRadius: 6 },
          { label: 'Estoque Atual', data: items.map(d => d.quantidade), backgroundColor: '#1C64AE', borderRadius: 6 }
        ]
      },
      options: {
        responsive: true,
        maintainAspectRatio: false,
        layout: { padding: { bottom: 20 } },
        scales: {
          x: { ticks: { color: textColor }, grid: { color: gridColor } },
          y: { beginAtZero: true, ticks: { color: textColor }, grid: { color: gridColor } }
        },
        plugins: {
          legend: { position: 'top', labels: { color: textColor } },
          tooltip: { enabled: true, backgroundColor: tooltipBg, titleColor: textColor, bodyColor: textColor }
        }
      }
    });
  }

  // initial populate and chart create
  populateTable(data);
  createChart2(data);

  // update when theme changes
  document.addEventListener('themeChanged', () => {
    populateTable(data);
    createChart2(data);
  });
}

loadData();
</script>

{% endblock %}
