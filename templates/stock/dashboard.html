{% extends 'stock/base.html' %}
{% block content %}

<div class="row g-3">

  <!-- Gr√°fico 1: Estoque por Material -->
  <div class="col-md-8">
    <div class="card shadow-sm mb-3">
      <div class="card-body" style="height:350px; padding-bottom:40px;">
        <h4 class="fw-bold mb-3 text-light">üì¶ Estoque por material</h4>
        <div style="position: relative; height:100%; width:100%;">
          <canvas id="estoqueChart"></canvas>
        </div>
      </div>
    </div>
  </div>

  <!-- Coluna lateral com Atalhos + Alertas -->
  <div class="col-md-4">
    <!-- Atalhos -->
    <div class="card shadow-sm mb-3">
      <div class="card-body">
        <h5 class="fw-bold mb-3 text-light">‚ÜóÔ∏èÔ∏è Atalhos</h5>
        <a class="btn btn-success w-100 mb-2" href="{% url 'materials_add' %}">Adicionar material</a>
        <a class="btn btn-primary w-100 mb-2" href="{% url 'movimento_add' %}">Registrar movimento</a>
        <a class="btn btn-danger w-100 mb-2" href="{% url 'materials_list' %}">Editar materiais</a>
      </div>
    </div>

<!-- Alertas -->
<div class="card shadow-sm" style="max-height:350px; overflow-y:auto;">
  <div class="card-header bg-warning text-dark d-flex justify-content-between align-items-center">
    <strong>‚ö†Ô∏è Materiais abaixo do m√≠nimo</strong>
    <a href="{% url 'alertas_completos' %}" class="btn btn-sm btn-outline-dark">Ver todos</a>
  </div>
  <ul class="list-group list-group-flush">
    {% if materiais_em_alerta %}
      {% for mat in materiais_em_alerta|slice:":2" %}  {# Mostra apenas os 2 primeiros #}
      <li class="list-group-item d-flex justify-content-between align-items-center">
        {{ mat.nome }}
        <span class="badge bg-danger rounded-pill">{{ mat.quantidade }}/{{ mat.minimo }}</span>
      </li>
      {% endfor %}
    {% else %}
      <li class="list-group-item text-center text-muted">
        Nenhum material abaixo do m√≠nimo.
      </li>
    {% endif %}
  </ul>
</div>

  </div>
</div>

<!-- Gr√°fico 2: Comparativo de Estoques -->
<div class="card shadow-sm mb-3 mt-3">
  <div class="card-body" style="height:350px; padding-bottom:40px;">
    <h4 class="fw-bold mb-3 text-light">üìà Comparativo de Estoques</h4>
    <div style="position: relative; height:100%; width:100%;">
      <canvas id="comparativoChart"></canvas>
    </div>
  </div>
</div>

<!-- Chart.js -->
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<script>
async function loadData() {
  const resp = await fetch('{% url "api_materials" %}');
  const data = await resp.json();

  const labels = data.map(d => d.nome);
  const values = data.map(d => d.quantidade);

  // === GR√ÅFICO 1: Estoque por Material ===
  const ctx1 = document.getElementById('estoqueChart').getContext('2d');
  new Chart(ctx1, {
    type: 'bar',
    data: {
      labels: labels,
      datasets: [{
        label: 'Quantidade',
        data: values,
        backgroundColor: '#1C64AE',
        borderRadius: 6
      }]
    },
    options: {
      responsive: true,
      maintainAspectRatio: false,
      layout: { padding: { bottom: 20 } },
      scales: {
        x: { ticks: { color: '#FFFFFF' }, grid: { color: 'rgba(255,255,255,0.1)' } },
        y: { beginAtZero: true, ticks: { color: '#FFFFFF' }, grid: { color: 'rgba(255,255,255,0.1)' } }
      },
      plugins: { legend: { position: 'top', labels: { color: '#FFFFFF' } } }
    }
  });

  // === GR√ÅFICO 2: Comparativo Vertical ===
  const ctx2 = document.getElementById('comparativoChart').getContext('2d');
  new Chart(ctx2, {
    type: 'bar',
    data: {
      labels: labels,
      datasets: [
        {
          label: 'M√≠nimo',
          data: data.map(d => d.minimo),
          backgroundColor: '#C0392B',
          borderRadius: 6
        },
        {
          label: 'Estoque Atual',
          data: values,
          backgroundColor: '#1C64AE',
          borderRadius: 6
        }
      ]
    },
    options: {
      responsive: true,
      maintainAspectRatio: false,
      layout: { padding: { bottom: 20 } },
      scales: {
        x: { ticks: { color: '#FFFFFF' }, grid: { color: 'rgba(255,255,255,0.1)' } },
        y: { beginAtZero: true, ticks: { color: '#FFFFFF' }, grid: { color: 'rgba(255,255,255,0.1)' } }
      },
      plugins: {
        legend: { position: 'top', labels: { color: '#FFFFFF' } },
        tooltip: {
          enabled: true,
          backgroundColor: '#001D40',
          titleColor: '#FFFFFF',
          bodyColor: '#FFFFFF'
        }
      }
    }
  });
}

loadData();
</script>

{% endblock %}
