{% extends 'stock/base.html' %}
{% block content %}

<div class="row g-3">

  <!-- Gr√°fico 1: Estoque por Material -->
  <div class="col-md-8">
    <div class="card shadow-sm mb-3">
      <div class="card-body" style="height:350px; padding-bottom:40px;">
        <h4 class="fw-bold mb-3 text-light">üì¶ Estoque por material</h4>
        <div style="position: relative; height:100%; width:100%;">
          <!-- Substitui o gr√°fico por uma tabela com scroll que lista materiais -->
          <div id="estoqueTableContainer" style="height:90%; width:100%; display:flex; flex-direction:column;">
            <div style="flex:1 1 auto; overflow:auto;">
              <table id="estoqueTable" class="table mb-0" style="background-color: transparent; border-radius: 8px;">
                <thead>
                  <tr>
                    <th class="text-light">Id</th>
                    <th class="text-light">Nome</th>
                    <th class="text-light">Quantidade</th>
                    <th class="text-light">Quantidade ideal</th>
                  </tr>
                </thead>
                <tbody>
                  {% for m in materiais %}
                  <tr>
                    <td>{{ forloop.counter }}.</td>
                    <td>
                      {% if m.imagem %}
                        <a href="#" class="material-name" data-img-url="{{ m.imagem.url }}">{{ m.nome }}</a>
                      {% else %}
                        {{ m.nome }}
                      {% endif %}
                    </td>
                    <td>{{ m.quantidade }}</td>
                    <td>{{ m.minimo }}</td>
                  </tr>
                  {% empty %}
                  <tr><td colspan="4" class="text-center text-muted">Nenhum material encontrado.</td></tr>
                  {% endfor %}
                </tbody>
              </table>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Coluna lateral com Atalhos + Alertas -->
  <div class="col-md-4">
    <!-- Atalhos -->
    <div class="card shadow-sm mb-3">
      <div class="card-body">
  <h5 class="fw-bold mb-3 text-light">‚ÜóÔ∏èÔ∏è Atalhos</h5>
        <a class="btn btn-success w-100 mb-2" href="{% url 'materials_add' %}">Adicionar material</a>
        <a class="btn btn-primary w-100 mb-2" href="{% url 'movimento_add' %}">Registrar movimento</a>
        <a class="btn btn-danger w-100 mb-2" href="{% url 'materials_list' %}">Editar materiais</a>
      </div>
    </div>

<!-- Alertas -->
<div class="card shadow-sm" style="max-height:350px; overflow-y:auto;">
  <div class="card-header bg-warning text-dark d-flex justify-content-between align-items-center">
  <strong>‚ö†Ô∏è Materiais abaixo da quantidade ideal</strong>
    <a href="{% url 'alertas_completos' %}" class="btn btn-sm btn-outline-dark">Ver todos</a>
  </div>
  <ul class="list-group list-group-flush">
    {% if materiais_em_alerta %}
      {% for mat in materiais_em_alerta|slice:":2" %}  {# Mostra apenas os 2 primeiros #}
      <li class="list-group-item d-flex justify-content-between align-items-center">
        {{ mat.nome }}
  <span class="badge bg-danger rounded-pill">{{ mat.quantidade }}/{{ mat.minimo }}</span>
      </li>
      {% endfor %}
    {% else %}
      <li class="list-group-item text-center text-muted">
  Nenhum material abaixo da Quantidade ideal.
      </li>
    {% endif %}
  </ul>
</div>

  </div>
</div>

<!-- Gr√°fico 2: Comparativo de Estoques -->
<div class="card shadow-sm mb-3 mt-3">
  <div class="card-body" style="height:350px; padding-bottom:40px;">
    <h4 class="fw-bold mb-3 text-light">üìà Comparativo de Estoques</h4>
    <div style="position: relative; height:100%; width:100%;">
      <canvas id="comparativoChart"></canvas>
    </div>
  </div>
</div>

<!-- Chart.js -->
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<script>
async function loadData() {
  const resp = await fetch('{% url "api_materials" %}');
  const data = await resp.json();

  const labels = data.map(d => d.nome);
  const values = data.map(d => d.quantidade);

  // Helper: map theme -> colors
  function getThemeColors() {
    const currentTheme = document.body.getAttribute('data-theme') || 'escuro';
    let textColor = '#FFFFFF';
    let tooltipBg = '#001D40';
    let gridColor = 'rgba(255,255,255,0.1)';
    if (currentTheme === 'claro') {
      textColor = '#000000';
      tooltipBg = '#ffffff';
      gridColor = 'rgba(0,0,0,0.12)';
    }
    return { currentTheme, textColor, tooltipBg, gridColor };
  }

  // Populate scrollable table with materials
  function populateTable(items) {
    const tbody = document.querySelector('#estoqueTable tbody');
    if (!tbody) return;
    tbody.innerHTML = '';
    if (!items || items.length === 0) {
      tbody.innerHTML = '<tr><td colspan="4" class="text-center text-muted">Nenhum material encontrado.</td></tr>';
      return;
    }

    // Create rows
    items.forEach((item, idx) => {
      const tr = document.createElement('tr');
      const tdIdx = document.createElement('td'); tdIdx.textContent = String(idx + 1) + '.';
      const tdName = document.createElement('td');
      // If the API provides an image URL, render a clickable anchor that will open the preview modal
      if (item.imagem_url) {
        const a = document.createElement('a');
        a.href = '#';
        a.className = 'material-name';
        a.setAttribute('data-img-url', item.imagem_url);
        a.textContent = item.nome;
        tdName.appendChild(a);
      } else {
        tdName.textContent = item.nome;
      }
      const tdQty = document.createElement('td'); tdQty.textContent = item.quantidade;
  const tdMin = document.createElement('td'); tdMin.textContent = item.minimo;
      tr.appendChild(tdIdx); tr.appendChild(tdName); tr.appendChild(tdQty); tr.appendChild(tdMin);
      tbody.appendChild(tr);
    });

    // Apply theme colors to header and cells
    const { textColor } = getThemeColors();
    document.querySelectorAll('#estoqueTable thead th').forEach(th => th.style.color = textColor);
    document.querySelectorAll('#estoqueTable tbody td').forEach(td => td.style.color = textColor);
  }

  // Chart 2 only (comparativo)
  let chart2 = null;
  function createChart2(items) {
    const { textColor, tooltipBg, gridColor } = getThemeColors();
    if (chart2) { chart2.destroy(); chart2 = null; }
    const ctx2 = document.getElementById('comparativoChart').getContext('2d');
    chart2 = new Chart(ctx2, {
      type: 'bar',
      data: {
        labels: items.map(d => d.nome),
        datasets: [
          { label: 'Quantidade ideal', data: items.map(d => d.minimo), backgroundColor: '#C0392B', borderRadius: 6 },
          { label: 'Estoque Atual', data: items.map(d => d.quantidade), backgroundColor: '#1C64AE', borderRadius: 6 }
        ]
      },
      options: {
        responsive: true,
        maintainAspectRatio: false,
        layout: { padding: { bottom: 20 } },
        scales: {
          x: { ticks: { color: textColor }, grid: { color: gridColor } },
          y: { beginAtZero: true, ticks: { color: textColor }, grid: { color: gridColor } }
        },
        plugins: {
          legend: { position: 'top', labels: { color: textColor } },
          tooltip: { enabled: true, backgroundColor: tooltipBg, titleColor: textColor, bodyColor: textColor }
        }
      }
    });
  }

  // initial populate and chart create
  populateTable(data);
  createChart2(data);

  // update when theme changes
  document.addEventListener('themeChanged', () => {
    populateTable(data);
    createChart2(data);
  });
}

loadData();
</script>

<!-- Image preview modal (centered) -->
<div id="imgModalDashboard" class="img-modal-overlay" style="display:none;">
  <div class="img-modal-content">
    <button type="button" class="img-modal-close" aria-label="Fechar">√ó</button>
    <img id="imgModalDashboardImg" src="" alt="Preview" class="img-modal-img">
  </div>
</div>

<style>
  .img-modal-overlay{position:fixed;inset:0;display:none;background:rgba(0,0,0,0.65);justify-content:center;align-items:center;z-index:1200}
  .img-modal-content{position:relative;max-width:96vw;max-height:92vh;display:flex;justify-content:center;align-items:center}
  .img-modal-img{max-width:100%;max-height:100%;object-fit:contain;border-radius:8px;box-shadow:0 8px 28px rgba(0,0,0,0.6)}
  .img-modal-close{position:absolute;top:-10px;right:-10px;background:#fff;border-radius:50%;width:36px;height:36px;border:none;cursor:pointer;box-shadow:0 4px 12px rgba(0,0,0,0.25)}
</style>

<script>
document.addEventListener('click', function(e){
  const a = e.target.closest && e.target.closest('.material-name');
  if (a){
    e.preventDefault();
    const url = a.dataset.imgUrl;
    if (!url) return;
    const modal = document.getElementById('imgModalDashboard');
    const img = document.getElementById('imgModalDashboardImg');
    const close = modal.querySelector('.img-modal-close');
    img.src = url; modal.style.display = 'flex'; document.body.style.overflow='hidden';
    function hide(){ modal.style.display='none'; img.src=''; document.body.style.overflow=''; }
    close.onclick = hide; modal.onclick = (ev)=>{ if(ev.target===modal) hide(); };
  }
});
</script>

{% endblock %}
