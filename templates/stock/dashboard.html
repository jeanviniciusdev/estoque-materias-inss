{% extends 'stock/base.html' %}
{% block content %}

<div class="row g-3">

  <!-- Gr√°fico 1: Estoque por Material -->
  <div class="col-md-8">
    <div class="card shadow-sm mb-3">
      <div class="card-body" style="height:350px; padding-bottom:40px;">
        <h4 class="fw-bold mb-3 text-light">üì¶ Estoque por material</h4>
        <div style="position: relative; height:100%; width:100%;">
          <canvas id="estoqueChart"></canvas>
        </div>
      </div>
    </div>
  </div>

  <!-- Coluna lateral com Atalhos + Alertas -->
  <div class="col-md-4">
    <!-- Atalhos -->
    <div class="card shadow-sm mb-3">
      <div class="card-body">
        <h5 class="fw-bold mb-3 text-light">‚ÜóÔ∏èÔ∏è Atalhos</h5>
        <a class="btn btn-success w-100 mb-2" href="{% url 'materials_add' %}">Adicionar material</a>
        <a class="btn btn-primary w-100 mb-2" href="{% url 'movimento_add' %}">Registrar movimento</a>
        <a class="btn btn-danger w-100 mb-2" href="{% url 'materials_list' %}">Editar materiais</a>
      </div>
    </div>

    <!-- Alertas (substitui bloco anterior) -->
    {% now "Y-m-d" as hoje %}

    <style>
      /* for√ßar cabe√ßalho preto com texto branco nas mini-tables */
      .mini-table thead { background:#000 !important; color:#fff !important; }
      .mini-table thead th { color:#fff !important; }
      /* tornar dropdown mais destacado e arredondado */
      .alerta-dropdown .btn { border-radius: 12px; font-weight:700; }
      .alerta-dropdown .dropdown-menu { border-radius: 10px; min-width: 220px; }
      /* alinhar t√≠tulo e controle na mesma linha verticalmente */
      .card-alerts .card-body.bg-warning { border-radius:12px 12px 0 0; }
      .card-alerts .card-header-row { display:flex; align-items:center; justify-content:space-between; gap:1rem; }
    </style>

    <div class="card shadow-sm mb-3 card-alerts" style="border-radius:12px; overflow:hidden;">
      <div class="card-body bg-warning">
        <div class="card-header-row">
          <div>
            <h5 class="fw-bold mb-0 text-dark" style="line-height:1.1;">Alertas</h5>
          </div>

          <div class="d-flex align-items-center gap-2">
            <div class="dropdown alerta-dropdown">
              <button class="btn btn-warning btn-sm dropdown-toggle text-dark" type="button" id="alertaDropdown" data-bs-toggle="dropdown" aria-expanded="false">
                Materiais abaixo do m√≠nimo
              </button>
              <ul class="dropdown-menu dropdown-menu-end" aria-labelledby="alertaDropdown">
                <li><a class="dropdown-item alerta-option" href="#" data-type="alertas">Materiais abaixo do m√≠nimo</a></li>
                <li><a class="dropdown-item alerta-option" href="#" data-type="emprestimos">Empr√©stimos em andamento</a></li>
              </ul>
            </div>

            <a id="ver-todos-link" href="{% url 'alertas_completos' %}" class="btn btn-sm btn-outline-dark">Ver todos</a>
          </div>
        </div>
      </div>

      <div class="card-body">
        <div id="mini-alertas">
          <table class="table table-sm table-hover table-bordered mb-0 table-full-alertas">
            <thead>
              <tr><th>Nome</th><th>Quantidade</th><th>M√≠nimo</th></tr>
            </thead>
            <tbody>
              {% for m in alertas_top|slice:":1" %}
              <tr>
                <td><a href="{% url 'materials_list' %}?filter={{ m.id }}" class="text-dark">{{ m.nome }}</a></td>
                <td>{{ m.quantidade }}</td>
                <td>{{ m.minimo }}</td>
              </tr>
              {% endfor %}
              {% if alertas_top|length == 0 %}
              <tr><td colspan="3" class="text-center text-muted">Nenhum material abaixo do m√≠nimo</td></tr>
              {% endif %}
            </tbody>
          </table>
        </div>

        <div id="mini-emprestimos" style="display:none;">
          <table class="table table-sm table-hover table-bordered mb-0 table-full-emprestimos">
            <thead>
              <tr><th>Material</th><th>Usu√°rio</th><th>Qtd</th><th>Devolu√ß√£o</th></tr>
            </thead>
            <tbody>
              {% for e in emprestimos_soon|slice:":1" %}
              <tr class="{% if e.data_devolucao and e.data_devolucao|stringformat:'s' < hoje %}table-danger{% endif %}">
                <td>{% if e.material %}{{ e.material.nome }}{% else %}{{ e.nota|default:"‚Äî" }}{% endif %}</td>
                <td>{% if e.usuario %}{{ e.usuario.username }}{% endif %}</td>
                <td>{{ e.quantidade }}</td>
                <td>{% if e.data_devolucao %}{{ e.data_devolucao|date:"d/m/Y" }}{% endif %}</td>
              </tr>
              {% endfor %}
              {% if emprestimos_soon|length == 0 %}
              <tr><td colspan="4" class="text-center text-muted">Nenhum empr√©stimo em andamento</td></tr>
              {% endif %}
            </tbody>
          </table>
        </div>
      </div>
    </div>

</div> <!-- Fecha a coluna lateral -->
</div> <!-- Fecha a row g-3 -->

<!-- Gr√°fico 2: Comparativo de Estoques (em tela cheia) -->
<div class="card shadow-sm mb-3 mt-3">
  <div class="card-body" style="height:420px; padding-bottom:40px;">
    <h4 class="fw-bold mb-3 text-light">üìà Comparativo de Estoques</h4>
    <div style="position: relative; height:100%; width:100%;">
      <canvas id="comparativoChart"></canvas>
    </div>
  </div>
</div>

<!-- Chart.js -->
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<script>
async function loadData() {
  const resp = await fetch('{% url "api_materials" %}');
  const data = await resp.json();

  const labels = data.map(d => d.nome);

  // === Converte valores e trata nulos ===
  const estoqueValues = data.map(d => {
    const val = (d.quantidade ?? 0);
    const parsed = Number(String(val).replace(',', '.'));
    return isNaN(parsed) ? 0 : parsed;
  });

  const minimoValues = data.map(d => {
    const val = (d.minimo ?? 0);
    const parsed = Number(String(val).replace(',', '.'));
    return isNaN(parsed) ? 0 : parsed;
  });

  // === GR√ÅFICO 1: Estoque por Material ===
  const ctx1 = document.getElementById('estoqueChart').getContext('2d');
  new Chart(ctx1, {
    type: 'bar',
    data: {
      labels: labels,
      datasets: [{
        label: 'Quantidade',
        data: estoqueValues,
        backgroundColor: '#1C64AE',
        borderRadius: 6
      }]
    },
    options: {
      responsive: true,
      maintainAspectRatio: false,
      layout: { padding: { bottom: 20 } },
      scales: {
        x: { ticks: { color: '#FFFFFF' }, grid: { color: 'rgba(255,255,255,0.1)' } },
        y: { beginAtZero: true, ticks: { color: '#FFFFFF' }, grid: { color: 'rgba(255,255,255,0.1)' } }
      },
      plugins: { legend: { position: 'top', labels: { color: '#FFFFFF' } } }
    }
  });

  // === GR√ÅFICO 2: Comparativo ===
  const ctx2 = document.getElementById('comparativoChart').getContext('2d');

  new Chart(ctx2, {
    type: 'bar',
    data: {
      labels: labels,
      datasets: [
        {
          label: 'M√≠nimo',
          data: minimoValues,
          backgroundColor: '#C0392B',
          borderRadius: 6
        },
        {
          label: 'Estoque Atual',
          data: estoqueValues,
          backgroundColor: '#1C64AE',
          borderRadius: 6
        }
      ]
    },
    options: {
      responsive: true,
      maintainAspectRatio: false,
      layout: { padding: { bottom: 20 } },
      scales: {
        x: {
          ticks: { color: '#FFFFFF' },
          grid: { color: 'rgba(255,255,255,0.1)' }
        },
        y: {
          beginAtZero: true,
          ticks: { color: '#FFFFFF' },
          grid: { color: 'rgba(255,255,255,0.1)' }
        }
      },
      plugins: {
        legend: { position: 'top', labels: { color: '#FFFFFF' } },
        tooltip: {
          enabled: true,
          backgroundColor: '#001D40',
          titleColor: '#FFFFFF',
          bodyColor: '#FFFFFF',
          callbacks: {
            label: function(ctx) {
              const v = ctx.parsed.y;
              return ctx.dataset.label + ': ' + (Number.isInteger(v) ? v : v.toFixed(2));
            }
          }
        }
      }
    }
  });
}

loadData();
</script>



    <script>
    document.addEventListener('DOMContentLoaded', function () {
      const btnAlertas = document.getElementById('btn-alertas');
      const btnEmprest = document.getElementById('btn-emprestimos');
      const tabelaAlertas = document.getElementById('tabela-alertas');
      const tabelaEmprest = document.getElementById('tabela-emprestimos');
      const nomeItems = document.querySelectorAll('.nome-item');
      const rowsAlertas = document.querySelectorAll('#tabela-alertas tbody tr');

      function showAlertas() {
        tabelaAlertas.style.display = '';
        tabelaEmprest.style.display = 'none';
        btnAlertas.classList.add('active');
        btnEmprest.classList.remove('active');
      }
      function showEmprestimos() {
        tabelaAlertas.style.display = 'none';
        tabelaEmprest.style.display = '';
        btnAlertas.classList.remove('active');
        btnEmprest.classList.add('active');
      }

      btnAlertas.addEventListener('click', showAlertas);
      btnEmprest.addEventListener('click', showEmprestimos);

      // clicar no nome na lista filtra a tabela (alertas) para mostrar s√≥ o material escolhido
      nomeItems.forEach(btn => {
        btn.addEventListener('click', function () {
          const type = this.dataset.type;
          const id = this.dataset.id;
          // se clicar em alerta, mostrar√° a tabela de alertas filtrada
          if (type === 'alerta') {
            showAlertas();
            rowsAlertas.forEach(r => {
              if (r.dataset.materialId === id) {
                r.style.display = '';
                r.classList.add('table-primary');
              } else {
                r.style.display = 'none';
                r.classList.remove('table-primary');
              }
            });
          } else if (type === 'emprestimo') {
            showEmprestimos();
            // opcional: destacar o empr√©stimo na tabela de empr√©stimos se existir
            document.querySelectorAll('#tabela-emprestimos tbody tr').forEach(tr => {
              tr.style.display = (tr.dataset.emprestimoId === id) ? '' : '';
            });
          }
        });
      });

      // permitir clicar no link do nome dentro da tabela para focar/filter
      document.querySelectorAll('.filtrar-material').forEach(a => {
        a.addEventListener('click', function (e) {
          e.preventDefault();
          const id = this.dataset.id;
          // simula click no correspondente da lista
          const item = document.querySelector('.nome-item[data-type="alerta"][data-id="' + id + '"]');
          if (item) item.click();
        });
      });

    });
    </script>

    <script>
    document.addEventListener('DOMContentLoaded', function () {
      const options = document.querySelectorAll('.alerta-option');
      const miniAlertas = document.getElementById('mini-alertas');
      const miniEmprest = document.getElementById('mini-emprestimos');
      const verTodos = document.getElementById('ver-todos-link');
      const dropdownBtn = document.getElementById('alertaDropdown');

      function showAlertas() {
        miniAlertas.style.display = '';
        miniEmprest.style.display = 'none';
        dropdownBtn.textContent = 'Materiais abaixo do m√≠nimo';
        verTodos.href = "{% url 'alertas_completos' %}";
      }
      function showEmprestimos() {
        miniAlertas.style.display = 'none';
        miniEmprest.style.display = '';
        dropdownBtn.textContent = 'Empr√©stimos em andamento';
        verTodos.href = "{% url 'emprestimos_list' %}";
      }

      options.forEach(opt => {
        opt.addEventListener('click', function (e) {
          e.preventDefault();
          const t = this.dataset.type;
          if (t === 'alertas') showAlertas();
          else if (t === 'emprestimos') showEmprestimos();
        });
      });

      // estado inicial: materiais (padr√£o)
      showAlertas();
    });
    </script>

    <style>
      /* destaque e bordas arredondadas do dropdown/btn */
      .alerta-dropdown .btn {
        border-radius: 12px;
        font-weight: 700;
      }
      .alerta-dropdown .dropdown-menu {
        border-radius: 10px;
        min-width: 220px;
      }
      /* padr√£o para mini-tables do resumo */
      .mini-table thead th { font-weight:700; color:#000; }
      .mini-table td, .mini-table th { vertical-align: middle; }
      .card-alerts .card-body.bg-warning { border-radius:12px 12px 0 0; }
    </style>

    <style>
      /* For√ßa cabe√ßalhos vis√≠veis para ambos os tipos (mini + full) dentro do card de Alertas */
      .card-alerts .table-full-alertas thead,
      .card-alerts .table-full-alertas thead th {
        background-color: #0B3D91 !important; /* laranja escuro */
        color: #fff !important;
      }

      .card-alerts .table-full-emprestimos thead,
      .card-alerts .table-full-emprestimos thead th {
        background-color: #0B3D91 !important; /* azul escuro */
        color: #fff !important;
      }

      /* Prioriza o cabe√ßalho definido acima sobre regras gen√©ricas do Bootstrap/temas */
      .card-alerts table thead th {
        color: #fff !important;
        font-weight: 700;
      }

      /* Cancela regras anteriores conflitantes */
      .mini-table.tabela-alertas thead th,
      .mini-table.tabela-emprestimos thead th {
        color: #fff !important;
        font-weight: 700;
      }
    </style>

{% endblock %}
