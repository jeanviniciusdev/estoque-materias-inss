{% extends 'stock/base.html' %}
{% block content %}
<div class="row">
  <!-- Gráfico de barras -->
  <div class="col-md-8">
    <div class="card shadow-sm mb-3" style="height:350px;">
      <div class="card-body" style="height:100%;">
        <h4>Estoque por material</h4>
        <canvas id="estoqueChart" style="height:250px; max-height:250px;"></canvas>
      </div>
    </div>
  </div>

  <!-- Atalhos -->
  <div class="col-md-4">
    <div class="card shadow-sm mb-3">
      <div class="card-body">
        <h5>Atalhos</h5>
        <a class="btn btn-sm btn-success mb-2" href="{% url 'materials_add' %}">Adicionar material</a>
        <a class="btn btn-sm btn-primary mb-2" href="{% url 'movimento_add' %}">Registrar movimento</a>
        <a class="btn btn-sm btn-danger mb-2" href="{% url 'materials_list' %}">Editar</a>
      </div>
    </div>

    <!-- Alertas abaixo dos atalhos -->
    {% if materiais_em_alerta %}
    <div class="card shadow-sm" style="max-height:350px; overflow-y:auto;">
      <div class="card-header bg-warning text-dark">
        <strong>⚠️ Materiais abaixo do mínimo</strong>
      </div>
      <ul class="list-group list-group-flush">
        {% for mat in materiais_em_alerta %}
        <li class="list-group-item d-flex justify-content-between align-items-center">
          {{ mat.nome }}
          <span class="badge bg-danger rounded-pill">{{ mat.quantidade }}/{{ mat.minimo }}</span>
        </li>
        {% endfor %}
      </ul>
    </div>
    {% endif %}
  </div>
</div>

<script>
async function loadData(){
  const resp = await fetch('{% url "api_materials" %}');
  const data = await resp.json();
  const labels = data.map(d => d.nome);
  const values = data.map(d => d.quantidade);

  const ctx = document.getElementById('estoqueChart').getContext('2d');
  new Chart(ctx, {
    type: 'bar',
    data: {
      labels: labels,
      datasets: [{
        label: 'Quantidade',
        data: values,
        backgroundColor: labels.map(() => 'rgba(3, 78, 162, 0.8)'),
      }]
    },
    options: {
      responsive: true,
      maintainAspectRatio: false,  // respeita altura fixa do canvas
      scales: {
        y: { beginAtZero: true }
      }
    }
  });
}
loadData();
</script>
{% endblock %}
